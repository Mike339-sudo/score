<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è´¨æ•°çŒäºº Â· iPhoneç‰ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            background: #111;
            color: #eee;
            text-align: center;
            margin: 0;
            touch-action: manipulation; /* ä¼˜åŒ–ç‚¹å‡»å“åº” */
        }
        h1 {
            color: #5ff;
            margin: 15px 0;
            font-size: 1.8rem;
        }
        .subtitle {
            font-size: 1rem;
            margin-bottom: 25px;
            color: #aaa;
        }
        .controls {
            margin: 25px 0;
        }
        button {
            padding: 15px 30px;
            margin: 0 8px;
            font-size: 18px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            background: #058;
            color: white;
            -webkit-tap-highlight-color: transparent; /* å»é™¤ç‚¹å‡»é«˜äº® */
            touch-action: manipulation;
            min-width: 120px;
        }
        button:hover, button:active {
            background: #07a;
            transform: scale(0.98);
        }
        button:disabled {
            background: #333;
            color: #777;
            cursor: not-allowed;
            transform: none;
        }
        .stat-box {
            background: #222;
            padding: 20px;
            margin: 20px auto;
            border-radius: 15px;
            max-width: 90%;
            text-align: left;
            font-size: 18px;
            line-height: 1.6;
        }
        .alert {
            background: #422;
            color: #fcc;
            padding: 15px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 90%;
            display: none;
            font-size: 16px;
        }
        #share-section {
            margin-top: 30px;
            padding: 25px;
            background: #223;
            border-radius: 15px;
            display: none;
            text-align: center;
        }
        #share-section button {
            margin-top: 15px;
            padding: 12px 25px;
        }
        /* æ·»åŠ åŠ è½½æç¤º */
        #loading {
            color: #aaa;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¢ è´¨æ•°çŒäºº</h1>
    <p class="subtitle">iPhone ä¸“å±ä¼˜åŒ–ç‰ˆ Â· å®‰å…¨ä¸å¡é¡¿</p>

    <div class="controls">
        <button id="start-btn" ontouchstart="">â–¶ï¸ å¼€å§‹æŒ‘æˆ˜</button>
        <button id="stop-btn" disabled ontouchstart="">â¹ï¸ åœæ­¢</button>
    </div>

    <div id="loading">é¦–æ¬¡å¯åŠ¨ä¸­ï¼Œè¯·ç¨å€™...</div>

    <div class="stat-box">
        <div>è´¨æ•°æ€»æ•°: <span id="prime-count">0</span></div>
        <div>å½“å‰æ•°å­—: <span id="current-num">2</span></div>
        <div>é€Ÿåº¦: <span id="speed">-- primes/sec</span></div>
        <div>è¿è¡Œæ—¶é—´: <span id="timer">0s</span></div>
    </div>

    <div id="protection-alert" class="alert">
        âš ï¸ æ£€æµ‹åˆ°è®¾å¤‡è´Ÿè½½è¿‡é«˜ï¼Œå·²è‡ªåŠ¨æš‚åœä»¥ä¿æŠ¤ç”µæ± å’Œæ€§èƒ½ã€‚
    </div>

    <div id="share-section">
        <h3>ğŸ† ä½ çš„æˆ˜ç»©ï¼š</h3>
        <div id="result-text">æ‰¾åˆ° 0 ä¸ªè´¨æ•°ï¼Œç”¨æ—¶ 0 ç§’ï¼</div>
        <button id="again-btn" ontouchstart="">ğŸ”„ å†æ¥ä¸€æ¬¡</button>
    </div>

    <script>
        let isRunning = false;
        let primeCount = 0;
        let currentNum = 2;
        let startTime;
        let lastCount = 0;
        let timerInterval;
        let taskHandle;
        let heartbeatMissed = 0;

        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const protectionAlert = document.getElementById('protection-alert');
        const shareSection = document.getElementById('share-section');
        const loading = document.getElementById('loading');

        // å…¼å®¹ touch å’Œ click
        function addSafeListener(element, handler) {
            element.addEventListener('click', handler);
            element.addEventListener('touchstart', handler, { passive: true });
        }

        addSafeListener(startBtn, startChallenge);
        addSafeListener(stopBtn, stopChallenge);
        addSafeListener(document.getElementById('again-btn'), () => {
            shareSection.style.display = 'none';
            startChallenge();
        });

        function isPrime(num) {
            if (num < 2) return false;
            if (num === 2) return true;
            if (num % 2 === 0) return false;
            for (let i = 3; i <= Math.sqrt(num); i += 2) {
                if (num % i === 0) return false;
            }
            return true;
        }

        function startChallenge() {
            if (isRunning) return;

            // é¦–æ¬¡å¯åŠ¨æç¤º
            loading.style.display = 'block';

            // å»¶è¿Ÿå¯åŠ¨ï¼Œç¡®ä¿ç”¨æˆ·æ‰‹åŠ¿ç”Ÿæ•ˆï¼ˆiOS å®‰å…¨ç­–ç•¥ï¼‰
            setTimeout(() => {
                loading.style.display = 'none';

                // é‡ç½®æ•°æ®
                primeCount = 0;
                currentNum = 2;
                document.getElementById('prime-count').innerText = '0';
                document.getElementById('current-num').innerText = '2';
                document.getElementById('speed').innerText = '-- primes/sec';
                document.getElementById('timer').innerText = '0s';
                protectionAlert.style.display = 'none';
                shareSection.style.display = 'none';

                isRunning = true;
                startTime = Date.now();
                lastCount = 0;
                heartbeatMissed = 0;

                startBtn.disabled = true;
                stopBtn.disabled = false;

                // ä½¿ç”¨ setTimeout åˆ†ç‰‡è®¡ç®—ï¼Œå…¼å®¹ iOS
                nextChunk();

                // å¯åŠ¨è®¡æ—¶å™¨
                timerInterval = setInterval(() => {
                    if (!isRunning) return;
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    document.getElementById('timer').innerText = elapsed + 's';
                }, 1000);

                // å¯åŠ¨æ€§èƒ½ç›‘æ§
                setTimeout(checkPerformance, 5000);
            }, 300);
        }

        function nextChunk() {
            if (!isRunning) return;

            const start = Date.now();
            let found = 0;

            // æ§åˆ¶æ¯è½®æœ€å¤šè®¡ç®— 30msï¼Œé¿å…é˜»å¡
            while (Date.now() - start < 30) {
                if (isPrime(currentNum)) {
                    found++;
                }
                currentNum++;

                // é˜²æ­¢æ•°å­—è¿‡å¤§
                if (currentNum > 1e9) currentNum = 2;
            }

            primeCount += found;
            const now = Date.now();
            const elapsed = (now - startTime) / 1000;
            const speed = Math.round(found / 0.03);

            // æ›´æ–° UI
            document.getElementById('prime-count').innerText = primeCount.toLocaleString();
            document.getElementById('current-num').innerText = currentNum.toLocaleString();
            document.getElementById('speed').innerText = speed.toLocaleString() + ' primes/sec';

            // å¿ƒè·³æ£€æµ‹
            heartbeatMissed = 0;
            setTimeout(() => {
                heartbeatMissed++;
                if (heartbeatMissed > 2 && isRunning) {
                    autoProtect();
                }
            }, 1000);

            // ç»§ç»­ä¸‹ä¸€å¸§
            taskHandle = setTimeout(nextChunk, 20);
        }

        function checkPerformance() {
            if (!isRunning) return;
            const speedText = document.getElementById('speed').innerText;
            const currentSpeed = parseInt(speedText) || 0;
            if (currentSpeed < lastCount * 0.4 && lastCount > 300) {
                autoProtect();
                return;
            }
            lastCount = currentSpeed;
            setTimeout(checkPerformance, 5000);
        }

        function autoProtect() {
            stopChallenge();
            protectionAlert.style.display = 'block';
        }

        function stopChallenge() {
            isRunning = false;
            if (taskHandle) {
                clearTimeout(taskHandle);
                taskHandle = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            startBtn.disabled = false;
            stopBtn.disabled = true;

            // æ˜¾ç¤ºç»“æœ
            const time = parseInt(document.getElementById('timer').innerText);
            document.getElementById('result-text').innerText = `æ‰¾åˆ° ${primeCount.toLocaleString()} ä¸ªè´¨æ•°ï¼Œç”¨æ—¶ ${time} ç§’ï¼`;
            shareSection.style.display = 'block';
        }

        // é¡µé¢è¿›å…¥åå°æ—¶è‡ªåŠ¨æš‚åœï¼ˆçœç”µ+å®‰å…¨ï¼‰
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isRunning) {
                console.log("App è¿›å…¥åå°ï¼Œè‡ªåŠ¨æš‚åœè®¡ç®—ä»¥èŠ‚çœç”µé‡");
                stopChallenge();
                protectionAlert.innerText = "ğŸ“± æ£€æµ‹åˆ°è¿›å…¥åå°ï¼Œå·²è‡ªåŠ¨æš‚åœ";
                protectionAlert.style.display = 'block';
            }
        });
    </script>
</body>
</html>
